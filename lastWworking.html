<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <link rel="icon" type="image/x-icon" href="./favicon.ico">
Â  <title>Still Waters Admin Panel - Enhanced</title>
Â  <style>
Â  Â  body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f3f6fb; margin: 0; padding: 0; }
Â  Â  header { background: linear-gradient(90deg, #0078D4, #005a9e); color: white; display: flex; align-items: center; justify-content: center; gap: 14px; padding: 18px 24px; box-shadow: 0 3px 8px rgba(0,0,0,0.2); }
Â  Â  .logo-section img { height: 52px; width: 52px; border-radius: 50%; background: white; object-fit: cover; box-shadow: 0 2px 6px rgba(255,255,255,0.2); }
Â  Â  .header-text { display: flex; flex-direction: column; align-items: center; text-align: center; }
Â  Â  .header-text h1 { margin: 0; font-size: 22px; letter-spacing: 0.3px; }
Â  Â  .header-text span { font-size: 14px; opacity: 0.95; }

Â  Â  .container { max-width: 900px; background: white; margin: 40px auto; padding: 32px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
Â  Â Â 
Â  Â  .tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e6ecf7; }
Â  Â  .tab { padding: 12px 24px; cursor: pointer; border-radius: 8px 8px 0 0; background: #f7faff; color: #555; font-weight: 600; transition: 0.3s; }
Â  Â  .tab.active { background: #0078D4; color: white; }
Â  Â  .tab:hover:not(.active) { background: #eef6ff; }

Â  Â  .tab-content { display: none; }
Â  Â  .tab-content.active { display: block; }

Â  Â  /* New Styles for Instructions */
Â  Â  .instruction-box { background: #f8f9fa; border-left: 5px solid #0078D4; padding: 20px; margin-bottom: 25px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
Â  Â  .instruction-box h3 { margin: 0 0 10px 0; color: #2b2b2b; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
Â  Â  .instruction-box p { margin: 0 0 10px 0; color: #555; font-size: 14px; line-height: 1.5; }
Â  Â  .instruction-box ul { margin: 0; padding-left: 20px; color: #555; font-size: 14px; }
Â  Â  .instruction-box li { margin-bottom: 6px; }

Â  Â  label { display: block; font-weight: 600; color: #333; margin-top: 18px; }
Â  Â  select, input { width: 100%; padding: 10px 12px; margin-top: 6px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; transition: 0.3s; background-color: #fafafa; box-sizing: border-box; }
Â  Â  select:focus, input:focus { border-color: #0078D4; outline: none; box-shadow: 0 0 5px rgba(0,120,212,0.3); background-color: #fff; }

Â  Â  .btn-group { margin-top: 26px; display: flex; gap: 12px; }
Â  Â  button { flex: 1; padding: 12px; border: none; border-radius: 6px; background: #0078D4; color: white; font-size: 15px; font-weight: 600; cursor: pointer; transition: 0.3s; }
Â  Â  button:hover:not(:disabled) { background: #005a9e; transform: translateY(-1px); }
Â  Â  button:disabled { opacity: 0.6; cursor: not-allowed; }

Â  Â  .slot-row { display: grid; grid-template-columns: 2fr 2fr 1.5fr auto; gap: 12px; align-items: end; margin-top: 12px; padding: 12px; background: #f9fbff; border-radius: 8px; border: 1px solid #e6ecf7; }
Â  Â  .slot-row label { margin-top: 0; font-size: 13px; }
Â  Â  .slot-row select, .slot-row input { margin-top: 4px; }
Â  Â  .remove-btn { padding: 10px 16px; background: #d13438; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; height: 42px; }
Â  Â  .remove-btn:hover { background: #a52a2d; }
Â  Â  .add-slot-btn { margin-top: 12px; padding: 10px; background: #107c10; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%; font-weight: 600; }
Â  Â  .add-slot-btn:hover { background: #0e6b0e; }

Â  Â  #toast { margin-top: 16px; }
Â  Â  .notice { padding: 12px 14px; border-radius: 8px; background: #f0f4ff; border: 1px solid #ccdfff; color: #1f3b78; font-weight: 500; }
Â  Â  .error { background: #fff0f0; border-color: #ffcccc; color: #8b0000; }
Â  Â  .success { background: #f0fff4; border-color: #ccffdd; color: #0e6b0e; }

Â  Â  #output { margin-top: 16px; }
Â  Â  .table-wrap { margin-top: 12px; overflow-x: auto; background: #fff; border: 1px solid #e6ecf7; border-radius: 10px; max-height: 500px; overflow-y: auto; }
Â  Â  table { width: 100%; border-collapse: collapse; min-width: 620px; }
Â  Â  thead th { position: sticky; top: 0; background: #f7faff; z-index: 10; }
Â  Â  th, td { padding: 12px 14px; border-bottom: 1px solid #eef2fb; text-align: left; font-size: 14px; }
Â  Â  tbody tr:hover { background: #f9fbff; }
Â  Â  .cal-name { font-weight: 600; color: #0f3f77; }
Â  Â  .day-badge { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #eef6ff; border: 1px solid #d9e9ff; font-size: 12px; }
Â  Â  .time-chip { display: inline-block; padding: 3px 7px; border-radius: 6px; background: #f5f7fb; border: 1px solid #e7ecf5; font-variant-numeric: tabular-nums; }
Â  Â  td strong { color: #0078D4; font-size: 15px; }
Â  Â  .type-default { color: #0078D4; }
Â  Â  .type-slot { color: #107c10; font-weight: 600; }

Â  Â  .section-title { font-size: 18px; font-weight: 700; color: #0078D4; margin-top: 12px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e6ecf7; }
Â  Â Â 
Â  Â  .info-box { background: #fff8e1; border: 1px solid #ffd54f; padding: 12px; border-radius: 6px; margin-top: 12px; font-size: 14px; color: #6b5b00; }

Â  Â  footer { text-align: center; margin-top: 48px; padding: 15px; font-size: 14px; color: #777; background-color: #f8f9fb; }
Â  </style>
</head>
<body>
Â  <header>
Â  Â  <div class="logo-section">
Â  Â  Â  <img src="logo.png" alt="Still Waters Logo" />
Â  Â  </div>
Â  Â  <div class="header-text">
Â  Â  Â  <h1>Still Waters Professional Counseling Services, Inc</h1>
Â  Â  Â  <span>Admin Panel â€“ Advanced Calendar Configuration</span>
Â  Â  </div>
Â  </header>

Â  <div class="container">
Â  Â  <div class="tabs">
Â  Â  Â  <div class="tab active" onclick="switchTab(event, 'basic')">ğŸ“… Basic Hours</div>
Â  Â  Â  <div class="tab" onclick="switchTab(event, 'slots')">ğŸ‘¥ Doctor Availability</div>
Â  Â  Â  <div class="tab" onclick="switchTab(event, 'view')">ğŸ“Š View All</div>
Â  Â  </div>

Â  Â  <div id="basic-tab" class="tab-content active">
Â  Â  Â  <div class="instruction-box">
Â  Â  Â  Â  <h3>ğŸ“‹ Step 1: Set Daily Operating Hours</h3>
Â  Â  Â  Â  <p>Use this section to define the <strong>standard opening and closing times</strong> for the clinic for a specific day.</p>
Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  <li><strong>Select a Calendar</strong> and a <strong>Day</strong> to begin.</li>
Â  Â  Â  Â  Â  Â  <li>Set the <strong>Start Time</strong> (Opening) and <strong>End Time</strong> (Closing).</li>
Â  Â  Â  Â  Â  Â  <li><strong>Default Doctor Count:</strong> Enter the minimum number of doctors available throughout the entire day. (e.g., Enter '1' if there is always at least one doctor present).</li>
Â  Â  Â  Â  </ul>
Â  Â  Â  </div>

Â  Â  Â  <div class="section-title">Configure Basic Working Hours</div>
Â  Â  Â Â 
Â  Â  Â  <label for="calendarSelect">Select Calendar</label>
Â  Â  Â  <select id="calendarSelect" onchange="onCalendarChange()">
Â  Â  Â  Â  <option value="">-- Select Calendar --</option>
Â  Â  Â  Â  <option value="Clinic Schedule">Clinic Schedule</option>
Â  Â  Â  Â  <option value="Augusta Clinic Scheduler">Augusta Clinic Scheduler</option>
Â  Â  Â  Â  <option value="Macon Clinic Schedule (Test)">Macon Clinic Schedule (Test)</option>
Â  Â  Â  </select>

Â  Â  Â  <label for="daySelect">Select Day</label>
Â  Â  Â  <select id="daySelect" onchange="onDayChange()" disabled>
Â  Â  Â  Â  <option value="">-- Select Day --</option>
Â  Â  Â  </select>

Â  Â  Â  <label for="startTime">Start Time</label>
Â  Â  Â  <select id="startTime" disabled></select>

Â  Â  Â  <label for="endTime">End Time</label>
Â  Â  Â  <select id="endTime" disabled></select>

Â  Â  Â  <label for="doctorCount">Default Doctor Count (Capacity)</label>
Â  Â  Â  <input type="number" id="doctorCount" min="1" max="5" value="1" disabled />

Â  Â  Â  <div class="info-box">
Â  Â  Â  Â  â„¹ï¸ <strong>Note:</strong> This sets the default capacity for the entire working day. Use the "Doctor Availability" tab to configure specific time slots with different capacities.
Â  Â  Â  </div>

Â  Â  Â  <div class="btn-group">
Â  Â  Â  Â  <button onclick="updateBasicHours()">ğŸ”„ Update Hours</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="slots-tab" class="tab-content">
Â  Â  Â  Â  <div class="instruction-box">
Â  Â  Â  Â  Â  Â  <h3>âš¡ Step 2: Increase Capacity for Specific Times</h3>
Â  Â  Â  Â  Â  Â  <p>Use this section if you have <strong>more than one doctor</strong> working during specific hours of the day.</p>
Â  Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  Â  Â  <li>This allows you to handle overlapping shifts.</li>
Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>Example:</strong> If your Basic Hours are 9 AM - 5 PM (1 Doctor), but a second doctor comes in from 1 PM - 4 PM, you would add a slot here for <strong>1 PM to 4 PM with 2 Doctors</strong>.</li>
Â  Â  Â  Â  Â  Â  Â  Â  <li>The system will automatically use the highest number of doctors you enter for any given time.</li>
Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  </div>

Â  Â  Â  <div class="section-title">Configure Doctor Availability by Time Slot</div>
Â  Â  Â Â 
Â  Â  Â  <label for="slotCalendarSelect">Select Calendar</label>
Â  Â  Â  <select id="slotCalendarSelect" onchange="onSlotCalendarChange()">
Â  Â  Â  Â  <option value="">-- Select Calendar --</option>
Â  Â  Â  Â  <option value="Augusta Clinic Scheduler">Augusta Clinic Scheduler</option>
Â  Â  Â  Â  <option value="Macon Clinic Schedule (Test)">Macon Clinic Schedule (Test)</option>
Â  Â  Â  </select>

Â  Â  Â  <label for="slotDaySelect">Select Day</label>
Â  Â  Â  <select id="slotDaySelect" onchange="loadExistingSlots()" disabled>
Â  Â  Â  Â  <option value="">-- Select Day --</option>
Â  Â  Â  </select>

Â  Â  Â  <div id="slotsContainer" style="display: none;">
Â  Â  Â  Â  <div class="section-title">Time Slots with Custom Capacity</div>
Â  Â  Â  Â  <div class="info-box">
Â  Â  Â  Â  Â  â„¹ï¸ <strong>How it works:</strong> Add specific time slots where more doctors are available. For example, if you have 2 doctors from 10 AM - 11 AM, the system will allow 2 concurrent bookings during that time.
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="slotsList"></div>
Â  Â  Â  Â  <button class="add-slot-btn" onclick="addSlotRow()">â• Add Time Slot</button>

Â  Â  Â  Â  <div class="btn-group">
Â  Â  Â  Â  Â  <button onclick="updateDoctorSlots()">ğŸ’¾ Save Doctor Slots</button>
Â  Â  Â  Â  Â  <button onclick="clearAllSlots()" style="background: #d13438;">ğŸ—‘ï¸ Clear All Slots</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="view-tab" class="tab-content">
Â  Â  Â  Â  <div class="instruction-box">
Â  Â  Â  Â  Â  Â  <h3>ğŸ“Š Review Schedule Configuration</h3>
Â  Â  Â  Â  Â  Â  <p>Click the button below to load a visual summary of the current schedule.</p>
Â  Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  Â  Â  <li>The table below combines your "Basic Hours" and "Doctor Availability" settings.</li>
Â  Â  Â  Â  Â  Â  Â  Â  <li>It calculates exactly how many doctors are available at every specific time block.</li>
Â  Â  Â  Â  Â  Â  Â  Â  <li>Use this to verify that your shifts are set up correctly before patients begin booking.</li>
Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  </div>

Â  Â  Â  <div class="section-title">Current Configuration</div>
Â  Â  Â  <div class="btn-group">
Â  Â  Â  Â  <button onclick="getData()">ğŸ“¥ Load Configuration</button>
Â  Â  Â  </div>
Â  Â  Â  <div id="output"></div>
Â  Â  </div>

Â  Â  <div id="toast"></div>
Â  </div>

Â  <footer>Â© 2025 Still Waters Professional Counseling Services, Inc â€” Admin Panel</footer>

<script>
Â  const containerUrl = "https://jsondata1.blob.core.windows.net/durastion/duration.json?sv=2024-11-04&ss=b&srt=sco&sp=rwdlaciytfx&se=2030-04-02T01:25:11Z&st=2025-10-07T17:10:11Z&spr=https,http&sig=zxKkoYOveKqc3I%2Bzz49eG5x%2FOjMV%2BJXHtsFoTcPENB0%3D";
Â  const blobName = "duration.json";

Â  const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
Â Â 
Â  let slotCounter = 0;

Â  // Initialize dropdowns
Â  function initializeDropdowns() {
Â  Â  const daySelects = [document.getElementById("daySelect"), document.getElementById("slotDaySelect")];
Â  Â  daySelects.forEach(sel => {
Â  Â  Â  days.forEach(day => {
Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  opt.value = day;
Â  Â  Â  Â  opt.textContent = day;
Â  Â  Â  Â  sel.appendChild(opt);
Â  Â  Â  });
Â  Â  });

Â  Â  const hourTimes = generateHourOptions();
Â  Â  const startSelect = document.getElementById("startTime");
Â  Â  const endSelect = document.getElementById("endTime");
Â  Â Â 
Â  Â  hourTimes.forEach(t => {
Â  Â  Â  const o1 = document.createElement("option"); o1.value = t; o1.textContent = t; startSelect.appendChild(o1);
Â  Â  Â  const o2 = document.createElement("option"); o2.value = t; o2.textContent = t; endSelect.appendChild(o2);
Â  Â  });
Â  }

Â  function generateHourOptions() {
Â  Â  const times = [];
Â  Â  for (let h = 6; h <= 22; h++) {
Â  Â  Â  const hour12 = (h % 12 === 0) ? 12 : (h % 12);
Â  Â  Â  const ampm = h < 12 ? "AM" : "PM";
Â  Â  Â  times.push(`${hour12}${ampm}`);
Â  Â  }
Â  Â  return times;
Â  }

Â  function switchTab(event, tabName) {
Â  Â  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
Â  Â  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
Â  Â Â 
Â  Â  event.target.classList.add('active');
Â  Â  document.getElementById(`${tabName}-tab`).classList.add('active');
Â  Â Â 
Â  Â  document.getElementById('toast').innerHTML = '';
Â  }

Â  function onCalendarChange() {
Â  Â  const calendar = document.getElementById("calendarSelect").value;
Â  Â  const daySelect = document.getElementById("daySelect");
Â  Â  const startSelect = document.getElementById("startTime");
Â  Â  const endSelect = document.getElementById("endTime");
Â  Â  const doctorCountInput = document.getElementById("doctorCount");

Â  Â  daySelect.value = "";
Â  Â  startSelect.value = "";
Â  Â  endSelect.value = "";
Â  Â  doctorCountInput.value = "1";

Â  Â  daySelect.disabled = !calendar;
Â  Â  startSelect.disabled = true;
Â  Â  endSelect.disabled = true;
Â  Â  doctorCountInput.disabled = true;
Â  }

Â  async function onDayChange() {
Â  Â  const calendar = document.getElementById("calendarSelect").value;
Â  Â  const day = document.getElementById("daySelect").value;
Â  Â Â 
Â  Â  if (!calendar || !day) return;
Â  Â Â 
Â  Â  const existing = await fetchExistingData();
Â  Â  const dayConfig = existing[calendar]?.[day];
Â  Â Â 
Â  Â  if (dayConfig) {
Â  Â  Â  document.getElementById("startTime").value = dayConfig.start || "9AM";
Â  Â  Â  document.getElementById("endTime").value = dayConfig.end || "5PM";
Â  Â  Â  document.getElementById("doctorCount").value = dayConfig.doctors || 1;
Â  Â  } else {
Â  Â  Â  document.getElementById("startTime").value = "9AM";
Â  Â  Â  document.getElementById("endTime").value = "5PM";
Â  Â  Â  document.getElementById("doctorCount").value = "1";
Â  Â  }
Â  Â Â 
Â  Â  document.getElementById("startTime").disabled = false;
Â  Â  document.getElementById("endTime").disabled = false;
Â  Â  document.getElementById("doctorCount").disabled = false;
Â  }

Â  function onSlotCalendarChange() {
Â  Â  const calendar = document.getElementById("slotCalendarSelect").value;
Â  Â  const slotDaySelect = document.getElementById("slotDaySelect");
Â  Â Â 
Â  Â  slotDaySelect.value = "";
Â  Â  slotDaySelect.disabled = !calendar;
Â  Â  document.getElementById("slotsContainer").style.display = "none";
Â  }

Â  async function loadExistingSlots() {
Â  Â  const calendar = document.getElementById("slotCalendarSelect").value;
Â  Â  const day = document.getElementById("slotDaySelect").value;
Â  Â Â 
Â  Â  if (!calendar || !day) return;

Â  Â  document.getElementById("slotsContainer").style.display = "block";
Â  Â  document.getElementById("slotsList").innerHTML = "";
Â  Â  slotCounter = 0;Â 

Â  Â  const existing = await fetchExistingData();
Â  Â  const slots = existing[calendar]?.[day]?.slots || [];

Â  Â  if (slots.length === 0) {
Â  Â  Â  addSlotRow();
Â  Â  } else {
Â  Â  Â  slots.forEach(slot => {
Â  Â  Â  Â  addSlotRow(slot.start, slot.end, slot.doctors);
Â  Â  Â  });
Â  Â  }
Â  }

Â  function addSlotRow(startVal = "", endVal = "", doctorsVal = 2) {
Â  Â  const container = document.getElementById("slotsList");
Â  Â  const id = `slot-${slotCounter++}`;
Â  Â Â 
Â  Â  const hourTimes = generateHourOptions();
Â  Â  const startOptions = hourTimes.map(t => `<option value="${t}" ${t === startVal ? 'selected' : ''}>${t}</option>`).join('');
Â  Â  const endOptions = hourTimes.map(t => `<option value="${t}" ${t === endVal ? 'selected' : ''}>${t}</option>`).join('');

Â  Â  const row = document.createElement('div');
Â  Â  row.className = 'slot-row';
Â  Â  row.id = id;
Â  Â  row.innerHTML = `
Â  Â  Â  <div>
Â  Â  Â  Â  <label>Start Time</label>
Â  Â  Â  Â  <select class="slot-start">${startOptions}</select>
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <label>End Time</label>
Â  Â  Â  Â  <select class="slot-end">${endOptions}</select>
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <label>Doctors Available</label>
Â  Â  Â  Â  <input type="number" class="slot-doctors" min="1" max="20" value="${doctorsVal}" />
Â  Â  Â  </div>
Â  Â  Â  <button class="remove-btn" onclick="removeSlotRow('${id}')">ğŸ—‘ï¸</button>
Â  Â  `;
Â  Â Â 
Â  Â  container.appendChild(row);
Â  }

Â  function removeSlotRow(id) {
Â  Â  const element = document.getElementById(id);
Â  Â  if (element) {
Â  Â  Â  element.remove();
Â  Â  }
Â  Â  if (document.querySelectorAll('.slot-row').length === 0) {
Â  Â  Â  addSlotRow();
Â  Â  }
Â  }

Â  function clearAllSlots() {
Â  Â  if (confirm("Are you sure you want to clear all time slots for this day?")) {
Â  Â  Â  document.getElementById("slotsList").innerHTML = "";
Â  Â  Â  slotCounter = 0;
Â  Â  Â  addSlotRow();
Â  Â  Â  showNotice("All slots cleared. Click 'Save Doctor Slots' to confirm.", "success");
Â  Â  }
Â  }

Â  function buildBlobUrl() {
Â  Â  const base = containerUrl.replace(/\?.*/, "");
Â  Â  const sas = containerUrl.match(/\?.*/)[0];
Â  Â  return `${base}/${blobName}${sas}`;
Â  }

Â  async function fetchExistingData() {
Â  Â  try {
Â  Â  Â  const response = await fetch(buildBlobUrl());
Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  return data;
Â  Â  Â  }
Â  Â  Â  return {};
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error fetching data:", error);
Â  Â  Â  return {};
Â  Â  }
Â  }

Â  function setButtonsDisabled(disabled) {
Â  Â  document.querySelectorAll("button").forEach(btn => {
Â  Â  Â  btn.disabled = disabled;
Â  Â  Â  btn.style.opacity = disabled ? 0.7 : 1;
Â  Â  });
Â  }

Â  function showNotice(text, type = "info") {
Â  Â  const className = type === "error" ? "notice error" : type === "success" ? "notice success" : "notice";
Â  Â  document.getElementById("toast").innerHTML = `<div class="${className}">${text}</div>`;
Â  Â  if (type === "success") {
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  document.getElementById("toast").innerHTML = "";
Â  Â  Â  }, 5000);
Â  Â  }
Â  }

Â  function nowStamp() {
Â  Â  try {
Â  Â  Â  return new Date().toLocaleString(undefined, {
Â  Â  Â  Â  year: "numeric", month: "short", day: "2-digit",
Â  Â  Â  Â  hour: "2-digit", minute: "2-digit", second: "2-digit"
Â  Â  Â  });
Â  Â  } catch {
Â  Â  Â  return new Date().toISOString();
Â  Â  }
Â  }

Â  async function uploadData(data, action) {
Â  Â  try {
Â  Â  Â  setButtonsDisabled(true);
Â  Â  Â  const response = await fetch(buildBlobUrl(), {
Â  Â  Â  Â  method: "PUT",
Â  Â  Â  Â  headers: {Â 
Â  Â  Â  Â  Â  "x-ms-blob-type": "BlockBlob",Â 
Â  Â  Â  Â  Â  "Content-Type": "application/json"Â 
Â  Â  Â  Â  },
Â  Â  Â  Â  body: JSON.stringify(data, null, 2)
Â  Â  Â  });

Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  showNotice(`âœ… ${action} successfully at <strong>${nowStamp()}</strong>`, "success");
Â  Â  Â  Â  return true;
Â  Â  Â  } else {
Â  Â  Â  Â  const errorText = await response.text();
Â  Â  Â  Â  showNotice(`âŒ Error: ${errorText}`, "error");
Â  Â  Â  Â  return false;
Â  Â  Â  }
Â  Â  } catch (err) {
Â  Â  Â  console.error("Upload error:", err);
Â  Â  Â  showNotice(`âŒ Exception: ${err.message}`, "error");
Â  Â  Â  return false;
Â  Â  } finally {
Â  Â  Â  setButtonsDisabled(false);
Â  Â  }
Â  }

Â  function toHourLabel(val) {
Â  Â  if (!val) return val;
Â  Â  if (/^\d{1,2}(AM|PM)$/.test(val)) return val;
Â  Â  const m = val.match(/^(\d{1,2})(?::(00|30))?(AM|PM)$/);
Â  Â  if (m) {
Â  Â  Â  const hour = m[1];
Â  Â  Â  const mins = m[2];
Â  Â  Â  const ap = m[3];
Â  Â  Â  return mins && mins !== "00" ? `${hour}:${mins}${ap}` : `${hour}${ap}`;
Â  Â  }
Â  Â  return val;
Â  }

Â  async function updateBasicHours() {
Â  Â  const calendar = document.getElementById("calendarSelect").value;
Â  Â  const day = document.getElementById("daySelect").value;
Â  Â  let start = toHourLabel(document.getElementById("startTime").value);
Â  Â  let end = toHourLabel(document.getElementById("endTime").value);
Â  Â  let doctors = parseInt(document.getElementById("doctorCount").value, 10);

Â  Â  if (!calendar || !day || !start || !end) {
Â  Â  Â  showNotice("âŒ Please select all fields!", "error");
Â  Â  Â  return;
Â  Â  }

Â  Â  if (isNaN(doctors) || doctors < 1) {
Â  Â  Â  showNotice("âŒ Doctor count must be at least 1!", "error");
Â  Â  Â  return;
Â  Â  }

Â  Â  const existing = await fetchExistingData();
Â  Â  if (!existing[calendar]) existing[calendar] = {};
Â  Â Â 
Â  Â  const currentSlots = existing[calendar][day]?.slots || [];
Â  Â  existing[calendar][day] = { start, end, doctors, slots: currentSlots };

Â  Â  await uploadData(existing, "Basic hours updated");
Â  }

Â  async function updateDoctorSlots() {
Â  Â  const calendar = document.getElementById("slotCalendarSelect").value;
Â  Â  const day = document.getElementById("slotDaySelect").value;

Â  Â  if (!calendar || !day) {
Â  Â  Â  showNotice("âŒ Please select calendar and day!", "error");
Â  Â  Â  return;
Â  Â  }

Â  Â  const slotRows = document.querySelectorAll('#slotsList .slot-row');
Â  Â  const slots = [];

Â  Â  for (const row of slotRows) {
Â  Â  Â  const start = toHourLabel(row.querySelector('.slot-start').value);
Â  Â  Â  const end = toHourLabel(row.querySelector('.slot-end').value);
Â  Â  Â  const doctors = parseInt(row.querySelector('.slot-doctors').value, 10);

Â  Â  Â  if (!start || !end) {
Â  Â  Â  Â  showNotice("âŒ Please fill in all time fields!", "error");
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  if (isNaN(doctors) || doctors < 1) {
Â  Â  Â  Â  showNotice("âŒ Doctor count must be at least 1 for each slot!", "error");
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  slots.push({ start, end, doctors });
Â  Â  }

Â  Â  const existing = await fetchExistingData();
Â  Â  if (!existing[calendar]) existing[calendar] = {};
Â  Â  if (!existing[calendar][day]) {
Â  Â  Â  existing[calendar][day] = { start: "9AM", end: "5PM", doctors: 1, slots: [] };
Â  Â  }
Â  Â  existing[calendar][day].slots = slots;
Â  Â Â 
Â  Â  const success = await uploadData(existing, "Doctor slots updated");
Â  Â  if (success) {
Â  Â  Â  setTimeout(() => loadExistingSlots(), 1000);
Â  Â  }
Â  }

Â  async function getData() {
Â  Â  const existing = await fetchExistingData();
Â  Â  renderDataTable(existing);
Â  }

Â  // ============================================================
Â  // NEW LOGIC: FLATTEN OVERLAPPING SLOTS FOR DISPLAY
Â  // ============================================================

Â  function parseTime(timeStr) {
Â  Â  if (!timeStr) return -1;
Â  Â  const match = timeStr.match(/^(\d{1,2})(?::(\d{2}))?(AM|PM)$/i);
Â  Â  if (!match) return -1;
Â  Â Â 
Â  Â  let hours = parseInt(match[1], 10);
Â  Â  const minutes = match[2] ? parseInt(match[2], 10) : 0;
Â  Â  const ampm = match[3].toUpperCase();

Â  Â  if (ampm === "PM" && hours < 12) hours += 12;
Â  Â  if (ampm === "AM" && hours === 12) hours = 0;

Â  Â  return (hours * 60) + minutes;
Â  }

Â  function formatMinToTime(totalMinutes) {
Â  Â  let h = Math.floor(totalMinutes / 60);
Â  Â  const m = totalMinutes % 60;
Â  Â  const ampm = h >= 12 ? "PM" : "AM";
Â  Â Â 
Â  Â  h = h % 12;
Â  Â  if (h === 0) h = 12;
Â  Â Â 
Â  Â  const minStr = m === 0 ? "" : `:${m.toString().padStart(2, '0')}`;
Â  Â  return `${h}${minStr}${ampm}`;
Â  }

Â  function calculateBreakdown(dayConfig) {
Â  Â  const { start, end, doctors, slots = [] } = dayConfig;
Â  Â Â 
Â  Â  const baseStart = parseTime(start);
Â  Â  const baseEnd = parseTime(end);
Â  Â  const baseDocs = parseInt(doctors || 1, 10);

Â  Â  let boundaries = new Set();
Â  Â  if (baseStart !== -1 && baseEnd !== -1) {
Â  Â  Â  boundaries.add(baseStart);
Â  Â  Â  boundaries.add(baseEnd);
Â  Â  }

Â  Â  const validSlots = slots.map(s => ({
Â  Â  Â  start: parseTime(s.start),
Â  Â  Â  end: parseTime(s.end),
Â  Â  Â  doctors: parseInt(s.doctors, 10)
Â  Â  })).filter(s => s.start !== -1 && s.end !== -1);

Â  Â  validSlots.forEach(s => {
Â  Â  Â  boundaries.add(s.start);
Â  Â  Â  boundaries.add(s.end);
Â  Â  });

Â  Â  const sortedPoints = Array.from(boundaries).sort((a, b) => a - b);
Â  Â  const segments = [];

Â  Â  for (let i = 0; i < sortedPoints.length - 1; i++) {
Â  Â  Â  const segStart = sortedPoints[i];
Â  Â  Â  const segEnd = sortedPoints[i+1];
Â  Â  Â  const midPoint = (segStart + segEnd) / 2;

Â  Â  Â  let activeDocs = 0;
Â  Â  Â  let type = '';
Â  Â  Â Â 
Â  Â  Â  // Check for slots (highest doc count wins)
Â  Â  Â  const activeSlot = validSlots
Â  Â  Â  Â  .filter(s => midPoint >= s.start && midPoint < s.end)
Â  Â  Â  Â  .sort((a, b) => b.doctors - a.doctors)[0];

Â  Â  Â  if (activeSlot) {
Â  Â  Â  Â  activeDocs = activeSlot.doctors;
Â  Â  Â  Â  type = 'Custom Slot';
Â  Â  Â  } else if (baseStart !== -1 && baseEnd !== -1 && midPoint >= baseStart && midPoint < baseEnd) {
Â  Â  Â  Â  activeDocs = baseDocs;
Â  Â  Â  Â  type = 'Base Hours';
Â  Â  Â  }

Â  Â  Â  if (activeDocs > 0) {
Â  Â  Â  Â  // Merge adjacent segments if identical stats
Â  Â  Â  Â  const prev = segments[segments.length - 1];
Â  Â  Â  Â  if (prev && prev.doctors === activeDocs && prev.type === type) {
Â  Â  Â  Â  Â  prev.end = segEnd;Â 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  segments.push({
Â  Â  Â  Â  Â  Â  start: segStart,
Â  Â  Â  Â  Â  Â  end: segEnd,
Â  Â  Â  Â  Â  Â  doctors: activeDocs,
Â  Â  Â  Â  Â  Â  type: type
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  return segments;
Â  }

Â  function renderDataTable(data) {
Â  Â  const rows = [];
Â  Â  const dayIndex = Object.fromEntries(days.map((d, i) => [d, i]));

Â  Â  Object.keys(data).sort().forEach(cal => {
Â  Â  Â  const byDay = data[cal] || {};
Â  Â  Â  Object.keys(byDay)
Â  Â  Â  Â  .sort((a, b) => (dayIndex[a] ?? 99) - (dayIndex[b] ?? 99))
Â  Â  Â  Â  .forEach(day => {
Â  Â  Â  Â  Â  const dayConfig = byDay[day];
Â  Â  Â  Â  Â  const segments = calculateBreakdown(dayConfig);

Â  Â  Â  Â  Â  if (segments.length === 0) return;

Â  Â  Â  Â  Â  segments.forEach((seg, index) => {
Â  Â  Â  Â  Â  Â  rows.push({
Â  Â  Â  Â  Â  Â  Â  cal: index === 0 ? cal : "",Â 
Â  Â  Â  Â  Â  Â  Â  day: index === 0 ? day : "",Â 
Â  Â  Â  Â  Â  Â  Â  start: formatMinToTime(seg.start),
Â  Â  Â  Â  Â  Â  Â  end: formatMinToTime(seg.end),
Â  Â  Â  Â  Â  Â  Â  doctors: seg.doctors,
Â  Â  Â  Â  Â  Â  Â  type: seg.type,
Â  Â  Â  Â  Â  Â  Â  isSlot: seg.type === 'Custom Slot'
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  });

Â  Â  if (rows.length === 0) {
Â  Â  Â  document.getElementById("output").innerHTML = `<div class="notice">ğŸ“­ No active schedule configuration found.</div>`;
Â  Â  Â  return;
Â  Â  }

Â  Â  const tableHtml = `
Â  Â  Â  <div class="table-wrap">
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th style="width: 25%">Calendar</th>
Â  Â  Â  Â  Â  Â  Â  <th style="width: 15%">Day</th>
Â  Â  Â  Â  Â  Â  Â  <th style="width: 15%">Start</th>
Â  Â  Â  Â  Â  Â  Â  <th style="width: 15%">End</th>
Â  Â  Â  Â  Â  Â  Â  <th style="width: 10%">Doctors</th>
Â  Â  Â  Â  Â  Â  Â  <th style="width: 20%">Source</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  ${rows.map(r => `
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="cal-name">${escapeHtml(r.cal)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.day ? `<span class="day-badge">${escapeHtml(r.day)}</span>` : ''}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="time-chip">${escapeHtml(r.start)}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="time-chip">${escapeHtml(r.end)}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><strong>${escapeHtml(r.doctors)}</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="${r.isSlot ? 'type-slot' : 'type-default'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${r.isSlot ? 'âš¡ Enhanced Capacity' : 'ğŸ“… Standard Shift'}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  `).join("")}
Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  `;
Â  Â  document.getElementById("output").innerHTML = tableHtml;
Â  }

Â  function escapeHtml(str) {
Â  Â  return String(str)
Â  Â  Â  .replaceAll("&", "&amp;")
Â  Â  Â  .replaceAll("<", "&lt;")
Â  Â  Â  .replaceAll(">", "&gt;")
Â  Â  Â  .replaceAll('"', "&quot;")
Â  Â  Â  .replaceAll("'", "&#039;");
Â  }

Â  initializeDropdowns();
</script>
</body>
</html>

