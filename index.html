<script>
  // === Your blob SAS URL ===
  const containerUrl =
    "https://jsondata1.blob.core.windows.net/durastion/duration.json?sv=2024-11-04&ss=b&srt=sco&sp=rwdlaciytfx&se=2030-04-02T01:25:11Z&st=2025-10-07T17:10:11Z&spr=https,http&sig=zxKkoYOveKqc3I%2Bzz49eG5x%2FOjMV%2BJXHtsFoTcPENB0%3D";
  const blobName = "duration.json";

  const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
  const startSelect = document.getElementById("startTime");
  const endSelect = document.getElementById("endTime");
  const daySelect = document.getElementById("daySelect");
  const output = document.getElementById("output");
  const toast = document.getElementById("toast");

  // Helper: timestamp string
  function nowStamp() {
    try {
      return new Date().toLocaleString(undefined, {
        year: "numeric", month: "short", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });
    } catch {
      return new Date().toISOString();
    }
  }

  // Populate day dropdown
  days.forEach(day => {
    const opt = document.createElement("option");
    opt.value = day;
    opt.textContent = day;
    daySelect.appendChild(opt);
  });

  // Generate HOURLY time options (6AMâ€“10PM) and display like "6AM", "12PM", etc.
  function generateHourOptions() {
    const times = [];
    for (let h = 6; h <= 22; h++) {
      const hour12 = (h % 12 === 0) ? 12 : (h % 12);
      const ampm = h < 12 ? "AM" : "PM";
      times.push(`${hour12}${ampm}`);
    }
    return times;
  }

  const hourTimes = generateHourOptions();
  hourTimes.forEach(t => {
    const o1 = document.createElement("option"); o1.value = t; o1.textContent = t; startSelect.appendChild(o1);
    const o2 = document.createElement("option"); o2.value = t; o2.textContent = t; endSelect.appendChild(o2);
  });

  function onCalendarChange() {
    const calendar = document.getElementById("calendarSelect").value;
    daySelect.disabled = !calendar;
    startSelect.disabled = true;
    endSelect.disabled = true;
  }
  function onDayChange() {
    startSelect.disabled = false;
    endSelect.disabled = false;
  }

  // Build URL to the blob with SAS
  function buildBlobUrl() {
    const base = containerUrl.replace(/\?.*/, "");
    const sas = containerUrl.match(/\?.*/)[0];
    return `${base}/${blobName}${sas}`;
  }

  async function fetchExistingData() {
    try {
      const response = await fetch(buildBlobUrl());
      if (response.ok) return await response.json();
      return {};
    } catch {
      return {};
    }
  }

  function setButtonsDisabled(disabled) {
    for (const btn of document.querySelectorAll(".btn-group button")) {
      btn.disabled = disabled;
      btn.style.opacity = disabled ? 0.7 : 1;
      btn.style.cursor = disabled ? "not-allowed" : "pointer";
    }
  }

  // Toast (does not get overwritten by table)
  function showNotice(text) {
    toast.innerHTML = `<div class="notice">${text}</div>`;
  }

  async function uploadData(data, action) {
    try {
      setButtonsDisabled(true);
      const response = await fetch(buildBlobUrl(), {
        method: "PUT",
        headers: { "x-ms-blob-type": "BlockBlob", "Content-Type": "application/json" },
        body: JSON.stringify(data, null, 2)
      });

      if (response.ok) {
        // âœ… On update we only show the success toast with a timestamp
        showNotice(`âœ… ${action} at <strong>${nowStamp()}</strong>`);
      } else {
        showNotice("âŒ Error: " + (await response.text()));
      }
    } catch (err) {
      showNotice("âŒ Exception: " + err.message);
    } finally {
      setButtonsDisabled(false);
    }
  }

  // Normalize to "9AM"/"12PM" etc. (in case options ever change later)
  function toHourLabel(val) {
    if (!val) return val;
    // already "9AM" style
    if (/^\d{1,2}(AM|PM)$/.test(val)) return val;
    // convert "9:00AM" -> "9AM", keep ":30" if ever present
    const m = val.match(/^(\d{1,2})(?::(00|30))?(AM|PM)$/);
    if (m) {
      const hour = m[1];
      const mins = m[2];
      const ap = m[3];
      return mins && mins !== "00" ? `${hour}:${mins}${ap}` : `${hour}${ap}`;
    }
    return val;
  }

  // === UPDATE-ONLY behavior ===
  async function updateData() {
    const calendar = document.getElementById("calendarSelect").value;
    const day = document.getElementById("daySelect").value;
    let start = document.getElementById("startTime").value;
    let end = document.getElementById("endTime").value;

    if (!calendar || !day || !start || !end) {
      alert("Please select all fields!");
      return;
    }

    // Enforce "9AM"/"12PM" style
    start = toHourLabel(start);
    end   = toHourLabel(end);

    const existing = await fetchExistingData();
    if (!existing[calendar]) {
      showNotice(`âŒ Calendar '${calendar}' not found in blob. Please initialize with the default JSON first.`);
      return;
    }
    if (!existing[calendar][day]) {
      showNotice(`âŒ Day '${day}' not found under '${calendar}'. Make sure the default JSON contains all days.`);
      return;
    }

    existing[calendar][day] = { start, end };

    // Clear table area (we only want the toast on update)
    output.innerHTML = "";
    await uploadData(existing, "Updated");
  }

  async function getData() {
    const existing = await fetchExistingData();
    renderDataTable(existing);
  }

  function renderDataTable(data) {
    // Flatten to rows: Calendar, Day, Start, End
    const rows = [];
    const dayIndex = Object.fromEntries(days.map((d, i) => [d, i]));

    Object.keys(data).sort().forEach(cal => {
      const byDay = data[cal] || {};
      Object.keys(byDay)
        .sort((a, b) => (dayIndex[a] ?? 99) - (dayIndex[b] ?? 99))
        .forEach(day => {
          const { start = "", end = "" } = byDay[day] || {};
          rows.push({ cal, day, start, end });
        });
    });

    if (rows.length === 0) {
      output.innerHTML = `<div class="notice">ðŸ“­ No data found in the blob.</div>`;
      return;
    }

    const tableHtml = `
      <div class="table-wrap">
        <table aria-label="Calendar Schedules">
          <thead>
            <tr>
              <th>Calendar</th>
              <th>Day</th>
              <th>Start</th>
              <th>End</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td class="cal-name">${escapeHtml(r.cal)}</td>
                <td><span class="day-badge">${escapeHtml(r.day)}</span></td>
                <td><span class="time-chip">${escapeHtml(r.start)}</span></td>
                <td><span class="time-chip">${escapeHtml(r.end)}</span></td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    `;
    output.innerHTML = tableHtml;
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
</script>
