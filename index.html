<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <title>Still Waters Admin Panel - Enhanced</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f3f6fb; margin: 0; padding: 0; }
    header { background: linear-gradient(90deg, #0078D4, #005a9e); color: white; display: flex; align-items: center; justify-content: center; gap: 14px; padding: 18px 24px; box-shadow: 0 3px 8px rgba(0,0,0,0.2); }
    .logo-section img { height: 52px; width: 52px; border-radius: 50%; background: white; object-fit: cover; box-shadow: 0 2px 6px rgba(255,255,255,0.2); }
    .header-text { display: flex; flex-direction: column; align-items: center; text-align: center; }
    .header-text h1 { margin: 0; font-size: 22px; letter-spacing: 0.3px; }
    .header-text span { font-size: 14px; opacity: 0.95; }

    .container { max-width: 900px; background: white; margin: 40px auto; padding: 32px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
    
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e6ecf7; }
    .tab { padding: 12px 24px; cursor: pointer; border-radius: 8px 8px 0 0; background: #f7faff; color: #555; font-weight: 600; transition: 0.3s; }
    .tab.active { background: #0078D4; color: white; }
    .tab:hover:not(.active) { background: #eef6ff; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* New Styles for Instructions */
    .instruction-box { background: #f8f9fa; border-left: 5px solid #0078D4; padding: 20px; margin-bottom: 25px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .instruction-box h3 { margin: 0 0 10px 0; color: #2b2b2b; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .instruction-box p { margin: 0 0 10px 0; color: #555; font-size: 14px; line-height: 1.5; }
    .instruction-box ul { margin: 0; padding-left: 20px; color: #555; font-size: 14px; }
    .instruction-box li { margin-bottom: 6px; }

    label { display: block; font-weight: 600; color: #333; margin-top: 18px; }
    select, input { width: 100%; padding: 10px 12px; margin-top: 6px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; transition: 0.3s; background-color: #fafafa; box-sizing: border-box; }
    select:focus, input:focus { border-color: #0078D4; outline: none; box-shadow: 0 0 5px rgba(0,120,212,0.3); background-color: #fff; }

    .btn-group { margin-top: 26px; display: flex; gap: 12px; }
    button { flex: 1; padding: 12px; border: none; border-radius: 6px; background: #0078D4; color: white; font-size: 15px; font-weight: 600; cursor: pointer; transition: 0.3s; }
    button:hover:not(:disabled) { background: #005a9e; transform: translateY(-1px); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .slot-row { display: grid; grid-template-columns: 2fr 2fr 1.5fr auto; gap: 12px; align-items: end; margin-top: 12px; padding: 12px; background: #f9fbff; border-radius: 8px; border: 1px solid #e6ecf7; }
    .slot-row label { margin-top: 0; font-size: 13px; }
    .slot-row select, .slot-row input { margin-top: 4px; }
    .remove-btn { padding: 10px 16px; background: #d13438; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; height: 42px; }
    .remove-btn:hover { background: #a52a2d; }
    .add-slot-btn { margin-top: 12px; padding: 10px; background: #107c10; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%; font-weight: 600; }
    .add-slot-btn:hover { background: #0e6b0e; }

    #toast { margin-top: 16px; }
    .notice { padding: 12px 14px; border-radius: 8px; background: #f0f4ff; border: 1px solid #ccdfff; color: #1f3b78; font-weight: 500; }
    .error { background: #fff0f0; border-color: #ffcccc; color: #8b0000; }
    .success { background: #f0fff4; border-color: #ccffdd; color: #0e6b0e; }

    #output { margin-top: 16px; }
    .table-wrap { margin-top: 12px; overflow-x: auto; background: #fff; border: 1px solid #e6ecf7; border-radius: 10px; max-height: 500px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 620px; }
    thead th { position: sticky; top: 0; background: #f7faff; z-index: 10; }
    th, td { padding: 12px 14px; border-bottom: 1px solid #eef2fb; text-align: left; font-size: 14px; }
    tbody tr:hover { background: #f9fbff; }
    .cal-name { font-weight: 600; color: #0f3f77; }
    .day-badge { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #eef6ff; border: 1px solid #d9e9ff; font-size: 12px; }
    .time-chip { display: inline-block; padding: 3px 7px; border-radius: 6px; background: #f5f7fb; border: 1px solid #e7ecf5; font-variant-numeric: tabular-nums; }
    td strong { color: #0078D4; font-size: 15px; }
    .type-default { color: #0078D4; }
    .type-slot { color: #107c10; font-weight: 600; }

    .section-title { font-size: 18px; font-weight: 700; color: #0078D4; margin-top: 12px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e6ecf7; }
    
    .info-box { background: #fff8e1; border: 1px solid #ffd54f; padding: 12px; border-radius: 6px; margin-top: 12px; font-size: 14px; color: #6b5b00; }

    footer { text-align: center; margin-top: 48px; padding: 15px; font-size: 14px; color: #777; background-color: #f8f9fb; }
  </style>
</head>
<body>
  <header>
    <div class="logo-section">
      <img src="logo.png" alt="Still Waters Logo" />
    </div>
    <div class="header-text">
      <h1>Still Waters Professional Counseling Services, Inc</h1>
      <span>Admin Panel ‚Äì Advanced Calendar Configuration</span>
    </div>
  </header>

  <div class="container">
    <div class="tabs">
      <div class="tab active" onclick="switchTab(event, 'basic')">üìÖ Basic Hours</div>
      <div class="tab" onclick="switchTab(event, 'slots')">üë• Doctor Availability</div>
      <div class="tab" onclick="switchTab(event, 'view')">üìä View All</div>
    </div>

    <div id="basic-tab" class="tab-content active">
      <div class="instruction-box">
        <h3>üìã Step 1: Set Daily Operating Hours</h3>
        <p>Use this section to define the <strong>standard opening and closing times</strong> for the clinic for a specific day.</p>
        <ul>
            <li><strong>Select a Calendar</strong> and a <strong>Day</strong> to begin.</li>
            <li>Set the <strong>Start Time</strong> (Opening) and <strong>End Time</strong> (Closing).</li>
            <li><strong>Default Doctor Count:</strong> Enter the minimum number of doctors available throughout the entire day. (e.g., Enter '1' if there is always at least one doctor present).</li>
        </ul>
      </div>

      <div class="section-title">Configure Basic Working Hours</div>
      
      <label for="calendarSelect">Select Calendar</label>
      <select id="calendarSelect" onchange="onCalendarChange()">
        <option value="">-- Select Calendar --</option>
        <option value="Clinic Schedule">Clinic Schedule</option>
        <option value="Augusta Clinic Scheduler">Augusta Clinic Scheduler</option>
        <option value="Macon Clinic Schedule (Test)">Macon Clinic Schedule (Test)</option>
      </select>

      <label for="daySelect">Select Day</label>
      <select id="daySelect" onchange="onDayChange()" disabled>
        <option value="">-- Select Day --</option>
      </select>

      <label for="startTime">Start Time</label>
      <select id="startTime" disabled></select>

      <label for="endTime">End Time</label>
      <select id="endTime" disabled></select>
<div id="doctorCountWrapper">
    <label for="doctorCount">Default Doctor Count (Capacity)</label>
    <input type="number" id="doctorCount" min="1" max="5" value="1" disabled />
</div>

      <div class="info-box">
        ‚ÑπÔ∏è <strong>Note:</strong> This sets the default capacity for the entire working day. Use the "Doctor Availability" tab to configure specific time slots with different capacities.
      </div>

      <div class="btn-group">
        <button onclick="updateBasicHours()">üîÑ Update Hours</button>
      </div>
    </div>

    <div id="slots-tab" class="tab-content">
        <div class="instruction-box">
            <h3>‚ö° Step 2: Increase Capacity for Specific Times</h3>
            <p>Use this section if you have <strong>more than one doctor</strong> working during specific hours of the day.</p>
            <ul>
                <li>This allows you to handle overlapping shifts.</li>
                <li><strong>Example:</strong> If your Basic Hours are 9 AM - 5 PM (1 Doctor), but a second doctor comes in from 1 PM - 4 PM, you would add a slot here for <strong>1 PM to 4 PM with 2 Doctors</strong>.</li>
                <li>The system will automatically use the highest number of doctors you enter for any given time.</li>
            </ul>
        </div>

      <div class="section-title">Configure Doctor Availability by Time Slot</div>
      
      <label for="slotCalendarSelect">Select Calendar</label>
      <select id="slotCalendarSelect" onchange="onSlotCalendarChange()">
        <option value="">-- Select Calendar --</option>
        <option value="Augusta Clinic Scheduler">Augusta Clinic Scheduler</option>
        <option value="Macon Clinic Schedule (Test)">Macon Clinic Schedule (Test)</option>
      </select>

      <label for="slotDaySelect">Select Day</label>
      <select id="slotDaySelect" onchange="loadExistingSlots()" disabled>
        <option value="">-- Select Day --</option>
      </select>

      <div id="slotsContainer" style="display: none;">
        <div class="section-title">Time Slots with Custom Capacity</div>
        <div class="info-box">
          ‚ÑπÔ∏è <strong>How it works:</strong> Add specific time slots where more doctors are available. For example, if you have 2 doctors from 10 AM - 11 AM, the system will allow 2 concurrent bookings during that time.
        </div>
        <div id="slotsList"></div>
        <button class="add-slot-btn" onclick="addSlotRow()">‚ûï Add Time Slot</button>

        <div class="btn-group">
          <button onclick="updateDoctorSlots()">üíæ Save Doctor Slots</button>
          <button onclick="clearAllSlots()" style="background: #d13438;">üóëÔ∏è Clear All Slots</button>
        </div>
      </div>
    </div>

    <div id="view-tab" class="tab-content">
        <div class="instruction-box">
            <h3>üìä Review Schedule Configuration</h3>
            <p>Click the button below to load a visual summary of the current schedule.</p>
            <ul>
                <li>The table below combines your "Basic Hours" and "Doctor Availability" settings.</li>
                <li>It calculates exactly how many doctors are available at every specific time block.</li>
                <li>Use this to verify that your shifts are set up correctly before patients begin booking.</li>
            </ul>
        </div>

      <div class="section-title">Current Configuration</div>
      <div class="btn-group">
        <button onclick="getData()">üì• Load Configuration</button>
      </div>
      <div id="output"></div>
    </div>

    <div id="toast"></div>
  </div>

  <footer>¬© 2025 Still Waters Professional Counseling Services, Inc ‚Äî Admin Panel</footer>

<script>
  const containerUrl = "https://jsondata1.blob.core.windows.net/durastion/duration.json?sv=2024-11-04&ss=b&srt=sco&sp=rwdlaciytfx&se=2030-04-02T01:25:11Z&st=2025-10-07T17:10:11Z&spr=https,http&sig=zxKkoYOveKqc3I%2Bzz49eG5x%2FOjMV%2BJXHtsFoTcPENB0%3D";
  const blobName = "duration.json";

  const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
  
  let slotCounter = 0;

  // Initialize dropdowns
  function initializeDropdowns() {
    const daySelects = [document.getElementById("daySelect"), document.getElementById("slotDaySelect")];
    daySelects.forEach(sel => {
      days.forEach(day => {
        const opt = document.createElement("option");
        opt.value = day;
        opt.textContent = day;
        sel.appendChild(opt);
      });
    });

    const hourTimes = generateHourOptions();
    const startSelect = document.getElementById("startTime");
    const endSelect = document.getElementById("endTime");
    
    hourTimes.forEach(t => {
      const o1 = document.createElement("option"); o1.value = t; o1.textContent = t; startSelect.appendChild(o1);
      const o2 = document.createElement("option"); o2.value = t; o2.textContent = t; endSelect.appendChild(o2);
    });
  }

  function generateHourOptions() {
    const times = [];
    for (let h = 6; h <= 22; h++) {
      const hour12 = (h % 12 === 0) ? 12 : (h % 12);
      const ampm = h < 12 ? "AM" : "PM";
      times.push(`${hour12}${ampm}`);
    }
    return times;
  }

  function switchTab(event, tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(`${tabName}-tab`).classList.add('active');
    
    document.getElementById('toast').innerHTML = '';
  }

  // UPDATED: Sets doctor count to empty instead of 1
  function onCalendarChange() {
    const calendar = document.getElementById("calendarSelect").value;
    const daySelect = document.getElementById("daySelect");
    const startSelect = document.getElementById("startTime");
    const endSelect = document.getElementById("endTime");
    const doctorCountInput = document.getElementById("doctorCount");
    const doctorCountWrapper = document.getElementById("doctorCountWrapper");

    daySelect.value = "";
    startSelect.value = "";
    endSelect.value = "";
    doctorCountInput.value = "1";

    // Enable/disable day selection as before
    daySelect.disabled = !calendar;
    startSelect.disabled = true;
    endSelect.disabled = true;
    doctorCountInput.disabled = true;

    // üî• NEW LOGIC:
    // Hide doctor count ONLY when "Clinic Schedule" is selected
    if (calendar === "Clinic Schedule") {
        doctorCountWrapper.style.display = "none";
    } else {
        doctorCountWrapper.style.display = "block";
    }
}

  async function onDayChange() {
    const calendar = document.getElementById("calendarSelect").value;
    const day = document.getElementById("daySelect").value;
    
    if (!calendar || !day) return;
    
    const existing = await fetchExistingData();
    const dayConfig = existing[calendar]?.[day];
    
    if (dayConfig) {
      document.getElementById("startTime").value = dayConfig.start || "9AM";
      document.getElementById("endTime").value = dayConfig.end || "5PM";
      document.getElementById("doctorCount").value = dayConfig.doctors || 1;
    } else {
      document.getElementById("startTime").value = "9AM";
      document.getElementById("endTime").value = "5PM";
      document.getElementById("doctorCount").value = "1";
    }
    
    document.getElementById("startTime").disabled = false;
    document.getElementById("endTime").disabled = false;
    document.getElementById("doctorCount").disabled = false;
  }

  function onSlotCalendarChange() {
    const calendar = document.getElementById("slotCalendarSelect").value;
    const slotDaySelect = document.getElementById("slotDaySelect");
    
    slotDaySelect.value = "";
    slotDaySelect.disabled = !calendar;
    document.getElementById("slotsContainer").style.display = "none";
  }

  async function loadExistingSlots() {
    const calendar = document.getElementById("slotCalendarSelect").value;
    const day = document.getElementById("slotDaySelect").value;
    
    if (!calendar || !day) return;

    document.getElementById("slotsContainer").style.display = "block";
    document.getElementById("slotsList").innerHTML = "";
    slotCounter = 0; 

    const existing = await fetchExistingData();
    const slots = existing[calendar]?.[day]?.slots || [];

    if (slots.length === 0) {
      addSlotRow();
    } else {
      slots.forEach(slot => {
        addSlotRow(slot.start, slot.end, slot.doctors);
      });
    }
  }

  function addSlotRow(startVal = "", endVal = "", doctorsVal = 2) {
    const container = document.getElementById("slotsList");
    const id = `slot-${slotCounter++}`;
    
    const hourTimes = generateHourOptions();
    const startOptions = hourTimes.map(t => `<option value="${t}" ${t === startVal ? 'selected' : ''}>${t}</option>`).join('');
    const endOptions = hourTimes.map(t => `<option value="${t}" ${t === endVal ? 'selected' : ''}>${t}</option>`).join('');

    const row = document.createElement('div');
    row.className = 'slot-row';
    row.id = id;
    row.innerHTML = `
      <div>
        <label>Start Time</label>
        <select class="slot-start">${startOptions}</select>
      </div>
      <div>
        <label>End Time</label>
        <select class="slot-end">${endOptions}</select>
      </div>
      <div>
        <label>Doctors Available</label>
        <input type="number" class="slot-doctors" min="1" max="20" value="${doctorsVal}" />
      </div>
      <button class="remove-btn" onclick="removeSlotRow('${id}')">üóëÔ∏è</button>
    `;
    
    container.appendChild(row);
  }

  function removeSlotRow(id) {
    const element = document.getElementById(id);
    if (element) {
      element.remove();
    }
    if (document.querySelectorAll('.slot-row').length === 0) {
      addSlotRow();
    }
  }

  function clearAllSlots() {
    if (confirm("Are you sure you want to clear all time slots for this day?")) {
      document.getElementById("slotsList").innerHTML = "";
      slotCounter = 0;
      addSlotRow();
      showNotice("All slots cleared. Click 'Save Doctor Slots' to confirm.", "success");
    }
  }

  function buildBlobUrl() {
    const base = containerUrl.replace(/\?.*/, "");
    const sas = containerUrl.match(/\?.*/)[0];
    return `${base}/${blobName}${sas}`;
  }

  async function fetchExistingData() {
    try {
      const response = await fetch(buildBlobUrl());
      if (response.ok) {
        const data = await response.json();
        return data;
      }
      return {};
    } catch (error) {
      console.error("Error fetching data:", error);
      return {};
    }
  }

  function setButtonsDisabled(disabled) {
    document.querySelectorAll("button").forEach(btn => {
      btn.disabled = disabled;
      btn.style.opacity = disabled ? 0.7 : 1;
    });
  }

  function showNotice(text, type = "info") {
    const className = type === "error" ? "notice error" : type === "success" ? "notice success" : "notice";
    document.getElementById("toast").innerHTML = `<div class="${className}">${text}</div>`;
    if (type === "success") {
      setTimeout(() => {
        document.getElementById("toast").innerHTML = "";
      }, 5000);
    }
  }

  function nowStamp() {
    try {
      return new Date().toLocaleString(undefined, {
        year: "numeric", month: "short", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });
    } catch {
      return new Date().toISOString();
    }
  }

  async function uploadData(data, action) {
    try {
      setButtonsDisabled(true);
      const response = await fetch(buildBlobUrl(), {
        method: "PUT",
        headers: { 
          "x-ms-blob-type": "BlockBlob", 
          "Content-Type": "application/json" 
        },
        body: JSON.stringify(data, null, 2)
      });

      if (response.ok) {
        showNotice(`‚úÖ ${action} successfully at <strong>${nowStamp()}</strong>`, "success");
        return true;
      } else {
        const errorText = await response.text();
        showNotice(`‚ùå Error: ${errorText}`, "error");
        return false;
      }
    } catch (err) {
      console.error("Upload error:", err);
      showNotice(`‚ùå Exception: ${err.message}`, "error");
      return false;
    } finally {
      setButtonsDisabled(false);
    }
  }

  function toHourLabel(val) {
    if (!val) return val;
    if (/^\d{1,2}(AM|PM)$/.test(val)) return val;
    const m = val.match(/^(\d{1,2})(?::(00|30))?(AM|PM)$/);
    if (m) {
      const hour = m[1];
      const mins = m[2];
      const ap = m[3];
      return mins && mins !== "00" ? `${hour}:${mins}${ap}` : `${hour}${ap}`;
    }
    return val;
  }

  async function updateBasicHours() {
    const calendar = document.getElementById("calendarSelect").value;
    const day = document.getElementById("daySelect").value;
    let start = toHourLabel(document.getElementById("startTime").value);
    let end = toHourLabel(document.getElementById("endTime").value);
    let doctors = parseInt(document.getElementById("doctorCount").value, 10);

    if (!calendar || !day || !start || !end) {
      showNotice("‚ùå Please select all fields!", "error");
      return;
    }

    if (isNaN(doctors) || doctors < 1) {
      showNotice("‚ùå Doctor count must be at least 1!", "error");
      return;
    }

    const existing = await fetchExistingData();
    if (!existing[calendar]) existing[calendar] = {};
    
    const currentSlots = existing[calendar][day]?.slots || [];
    existing[calendar][day] = { start, end, doctors, slots: currentSlots };

    await uploadData(existing, "Basic hours updated");
  }

  async function updateDoctorSlots() {
    const calendar = document.getElementById("slotCalendarSelect").value;
    const day = document.getElementById("slotDaySelect").value;

    if (!calendar || !day) {
      showNotice("‚ùå Please select calendar and day!", "error");
      return;
    }

    const slotRows = document.querySelectorAll('#slotsList .slot-row');
    const slots = [];

    for (const row of slotRows) {
      const start = toHourLabel(row.querySelector('.slot-start').value);
      const end = toHourLabel(row.querySelector('.slot-end').value);
      const doctors = parseInt(row.querySelector('.slot-doctors').value, 10);

      if (!start || !end) {
        showNotice("‚ùå Please fill in all time fields!", "error");
        return;
      }
      if (isNaN(doctors) || doctors < 1) {
        showNotice("‚ùå Doctor count must be at least 1 for each slot!", "error");
        return;
      }
      slots.push({ start, end, doctors });
    }

    const existing = await fetchExistingData();
    if (!existing[calendar]) existing[calendar] = {};
    if (!existing[calendar][day]) {
      existing[calendar][day] = { start: "9AM", end: "5PM", doctors: 1, slots: [] };
    }
    existing[calendar][day].slots = slots;
    
    const success = await uploadData(existing, "Doctor slots updated");
    if (success) {
      setTimeout(() => loadExistingSlots(), 1000);
    }
  }

  async function getData() {
    const existing = await fetchExistingData();
    renderDataTable(existing);
  }

  // ============================================================
  // NEW LOGIC: FLATTEN OVERLAPPING SLOTS FOR DISPLAY
  // ============================================================

  function parseTime(timeStr) {
    if (!timeStr) return -1;
    const match = timeStr.match(/^(\d{1,2})(?::(\d{2}))?(AM|PM)$/i);
    if (!match) return -1;
    
    let hours = parseInt(match[1], 10);
    const minutes = match[2] ? parseInt(match[2], 10) : 0;
    const ampm = match[3].toUpperCase();

    if (ampm === "PM" && hours < 12) hours += 12;
    if (ampm === "AM" && hours === 12) hours = 0;

    return (hours * 60) + minutes;
  }

  function formatMinToTime(totalMinutes) {
    let h = Math.floor(totalMinutes / 60);
    const m = totalMinutes % 60;
    const ampm = h >= 12 ? "PM" : "AM";
    
    h = h % 12;
    if (h === 0) h = 12;
    
    const minStr = m === 0 ? "" : `:${m.toString().padStart(2, '0')}`;
    return `${h}${minStr}${ampm}`;
  }

  function calculateBreakdown(dayConfig) {
    const { start, end, doctors, slots = [] } = dayConfig;
    
    const baseStart = parseTime(start);
    const baseEnd = parseTime(end);
    const baseDocs = parseInt(doctors || 1, 10);

    let boundaries = new Set();
    if (baseStart !== -1 && baseEnd !== -1) {
      boundaries.add(baseStart);
      boundaries.add(baseEnd);
    }

    const validSlots = slots.map(s => ({
      start: parseTime(s.start),
      end: parseTime(s.end),
      doctors: parseInt(s.doctors, 10)
    })).filter(s => s.start !== -1 && s.end !== -1);

    validSlots.forEach(s => {
      boundaries.add(s.start);
      boundaries.add(s.end);
    });

    const sortedPoints = Array.from(boundaries).sort((a, b) => a - b);
    const segments = [];

    for (let i = 0; i < sortedPoints.length - 1; i++) {
      const segStart = sortedPoints[i];
      const segEnd = sortedPoints[i+1];
      const midPoint = (segStart + segEnd) / 2;

      let activeDocs = 0;
      let type = '';
      
      // Check for slots (highest doc count wins)
      const activeSlot = validSlots
        .filter(s => midPoint >= s.start && midPoint < s.end)
        .sort((a, b) => b.doctors - a.doctors)[0];

      if (activeSlot) {
        activeDocs = activeSlot.doctors;
        type = 'Custom Slot';
      } else if (baseStart !== -1 && baseEnd !== -1 && midPoint >= baseStart && midPoint < baseEnd) {
        activeDocs = baseDocs;
        type = 'Base Hours';
      }

      if (activeDocs > 0) {
        // Merge adjacent segments if identical stats
        const prev = segments[segments.length - 1];
        if (prev && prev.doctors === activeDocs && prev.type === type) {
          prev.end = segEnd; 
        } else {
          segments.push({
            start: segStart,
            end: segEnd,
            doctors: activeDocs,
            type: type
          });
        }
      }
    }

    return segments;
  }

  function renderDataTable(data) {
    const rows = [];
    const dayIndex = Object.fromEntries(days.map((d, i) => [d, i]));

    Object.keys(data).sort().forEach(cal => {
      const byDay = data[cal] || {};
      Object.keys(byDay)
        .sort((a, b) => (dayIndex[a] ?? 99) - (dayIndex[b] ?? 99))
        .forEach(day => {
          const dayConfig = byDay[day];
          const segments = calculateBreakdown(dayConfig);

          if (segments.length === 0) return;

          segments.forEach((seg, index) => {
            rows.push({
              cal: index === 0 ? cal : "", 
              day: index === 0 ? day : "", 
              start: formatMinToTime(seg.start),
              end: formatMinToTime(seg.end),
              doctors: seg.doctors,
              type: seg.type,
              isSlot: seg.type === 'Custom Slot'
            });
          });
        });
    });

    if (rows.length === 0) {
      document.getElementById("output").innerHTML = `<div class="notice">üì≠ No active schedule configuration found.</div>`;
      return;
    }

    const tableHtml = `
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width: 25%">Calendar</th>
              <th style="width: 15%">Day</th>
              <th style="width: 15%">Start</th>
              <th style="width: 15%">End</th>
              <th style="width: 10%">Doctors</th>
              <th style="width: 20%">Source</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td class="cal-name">${escapeHtml(r.cal)}</td>
                <td>${r.day ? `<span class="day-badge">${escapeHtml(r.day)}</span>` : ''}</td>
                <td><span class="time-chip">${escapeHtml(r.start)}</span></td>
                <td><span class="time-chip">${escapeHtml(r.end)}</span></td>
                <td><strong>${escapeHtml(r.doctors)}</strong></td>
                <td class="${r.isSlot ? 'type-slot' : 'type-default'}">
                   ${r.isSlot ? '‚ö° Enhanced Capacity' : 'üìÖ Standard Shift'}
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    `;
    document.getElementById("output").innerHTML = tableHtml;
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  initializeDropdowns();
</script>
</body>
</html>